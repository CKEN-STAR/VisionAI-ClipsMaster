# 异常恢复验证测试

本文档介绍如何运行VisionAI-ClipsMaster的异常恢复验证测试，特别是针对内存溢出(OOM)等严重错误情况下的自动恢复能力测试。

## 测试目的

异常恢复验证测试旨在确保系统在遇到以下情况时能够自动恢复：

1. **内存溢出(OOM)错误** - 当系统内存不足时能够释放资源并恢复
2. **模型加载失败** - 当模型损坏或加载失败时能够降级运行
3. **活动任务中断** - 当处理任务中断时能够从保存点恢复
4. **资源泄漏** - 能够检测和清理泄漏的系统资源

## 测试标准

根据项目要求，恢复功能必须满足以下标准：

1. 核心功能在60秒内恢复
2. 内存使用回落到安全阈值(低于70%)
3. 生成完整的崩溃报告
4. 所有活动任务状态得到保存

## 运行测试

### 方法一：使用验证脚本(推荐)

在项目根目录执行：

```bash
python verify_recovery.py --report
```

这将运行所有恢复测试并生成HTML报告。

### 方法二：直接运行测试模块

```bash
python tests/run_recovery_test.py
```

### 命令行参数

支持以下参数：

- `--test`, `-t`: 指定要运行的测试用例，例如 `RecoveryTest.test_post_oom_recovery`
- `--report`, `-r`: 生成HTML报告
- `--verbose`, `-v`: 显示详细输出
- `--output-dir`, `-o`: 指定报告输出目录

示例：

```bash
python verify_recovery.py -t RecoveryTest.test_post_oom_recovery -r -v
```

## 测试用例说明

主要测试用例包括：

1. **test_post_oom_recovery**: 内存溢出后的恢复测试
   - 故意分配大量内存触发OOM错误
   - 验证系统能否自动恢复
   - 验证内存是否回落到安全水平

2. **test_recovery_with_active_tasks**: 有活动任务时的恢复测试
   - 创建模拟任务并保存进度
   - 触发OOM错误
   - 验证任务状态是否正确保存并恢复

3. **test_recovery_crash_report_generation**: 崩溃报告生成测试
   - 触发系统崩溃
   - 验证是否生成包含必要信息的崩溃报告

4. **test_recovery_performance**: 恢复性能测试
   - 测量恢复所需时间
   - 验证恢复时间是否在要求范围内

## 测试报告

测试完成后，HTML报告将生成在 `reports/` 目录下，包含：

- 测试结果摘要
- 详细测试结果
- 恢复性能数据
- 系统资源使用情况

## 故障排除

如果测试失败，请检查：

1. 系统资源是否充足
2. 是否已安装必要的依赖包：`psutil`、`loguru`
3. 日志文件(`logs/`)是否有详细错误信息
4. 崩溃报告(`logs/crash_reports/`)是否包含更多详情

## 常见问题

**Q: 为什么测试过程中我的电脑变慢或者冻结？**

A: 这是正常现象。测试需要耗尽内存来触发OOM错误，这会临时影响系统性能，但测试会快速释放这些资源。

**Q: 如何查看更详细的错误信息？**

A: 添加 `-v` 参数启用详细输出，或查看 `logs/` 目录下的日志文件。

**Q: 测试结果不稳定怎么办？**

A: 在系统资源较为空闲的情况下重新运行测试，确保没有其他内存密集型应用在运行。 