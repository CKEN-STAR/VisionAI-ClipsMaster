# VisionAI-ClipsMaster 错误恢复测试套件

本文档介绍 VisionAI-ClipsMaster 应用程序的错误恢复测试套件，包括其设计理念、测试范围、使用方法和扩展指南。

## 概述

错误恢复测试套件旨在验证 VisionAI-ClipsMaster 应用程序在面对各种异常情况时的恢复能力。该测试套件通过模拟不同类型的错误和故障，测试系统的自动恢复机制和断点续传功能，确保应用程序在实际使用中具有足够的健壮性和可靠性。

## 测试范围

测试套件覆盖以下错误恢复场景：

1. **基础错误处理**：测试错误处理器的基本功能，包括错误统计、错误分发和处理流程。
2. **文件错误恢复**：测试各种文件（SRT、模型、配置等）损坏后的自动修复能力。
3. **内存错误恢复**：测试内存溢出和资源耗尽情况下的恢复策略。
4. **处理中断恢复**：测试任务中断后的断点续传和任务恢复能力。
5. **网络错误恢复**：测试网络连接中断和服务不可用情况下的恢复能力。
6. **级联错误恢复**：测试连锁错误发生时的多层次恢复能力。
7. **资源耗尽恢复**：测试系统资源（磁盘空间、内存、CPU）耗尽时的自动降级和恢复。
8. **不可恢复错误处理**：测试面对无法自动恢复的错误时的正确降级和用户通知。

## 文件结构

```
tests/
├── test_error_recovery.py      # 错误恢复基础测试
├── test_error_simulation.py    # 错误模拟和恢复测试
├── run_error_recovery_tests.py # 测试运行和报告生成工具
└── ERROR_RECOVERY_README.md    # 本文档
```

## 主要测试类

### TestErrorRecovery

`TestErrorRecovery` 类测试错误处理系统的基础功能，包括：

- 错误处理器初始化和配置
- 错误捕获和分类
- 自定义错误处理器注册
- 错误装饰器和安全执行
- 恢复点创建和管理
- 任务恢复和断点续传

### TestErrorSimulation

`TestErrorSimulation` 类专注于模拟各种错误场景，并测试系统的恢复能力：

- 文件损坏和修复
- 网络中断和重连
- 内存溢出和资源释放
- 处理超时和恢复
- 级联错误恢复
- 多次失败后的最终恢复

## 使用方法

### 运行所有测试

```bash
python tests/run_error_recovery_tests.py
```

### 运行选项

- `-v, --verbosity`：设置输出详细级别 (1-3)
- `-o, --output-dir`：指定报告输出目录
- `--no-report`：不生成 HTML 报告

### 示例

```bash
# 运行测试并使用最高详细级别
python tests/run_error_recovery_tests.py -v 3

# 指定报告输出目录
python tests/run_error_recovery_tests.py -o ./my_reports

# 只运行测试，不生成报告
python tests/run_error_recovery_tests.py --no-report
```

## 报告解读

生成的 HTML 报告包含以下部分：

1. **测试结果摘要**：总体成功率、测试数量、失败数量等
2. **测试套件结果**：各个测试套件的详细结果
3. **错误恢复特性总结**：各类错误的恢复能力和成功率
4. **失败测试详情**：任何失败或错误测试的详细信息和堆栈跟踪

## 扩展测试套件

### 添加新的错误类型测试

1. 在 `test_error_simulation.py` 中添加新的测试方法
2. 确保测试方法名以 `test_` 开头
3. 模拟特定错误类型并验证恢复过程
4. 在 `run_error_recovery_tests.py` 的 `collect_test_results` 函数中更新恢复统计信息

### 添加新的恢复策略测试

1. 在 `test_error_recovery.py` 中添加新的测试方法
2. 测试新策略对特定错误类型的处理能力
3. 验证错误统计和恢复结果

## 测试设计原则

1. **隔离性**：每个测试应独立运行，不依赖其他测试的状态
2. **可重现性**：测试结果应可重现，避免随机因素影响
3. **完整性**：测试应覆盖正常路径和异常路径
4. **自动化**：测试应完全自动化，无需人工干预
5. **明确的断言**：每个测试应有明确的预期结果和验证

## 常见问题

**Q: 如何模拟特定类型的错误？**

A: 使用 `TestErrorSimulation` 类中的 `_corrupt_file` 方法可以模拟文件损坏；使用 mock 对象和 patch 装饰器可以模拟其他类型的错误。

**Q: 测试报告显示"弱"恢复能力是否表示问题？**

A: 不一定。某些错误（如严重安全漏洞）本来就不应该自动恢复，应该要求用户干预。

**Q: 如何测试真实环境中的错误恢复？**

A: 可以结合使用混沌测试技术，在实际运行环境中随机注入错误，观察系统恢复情况。

## 贡献

欢迎贡献新的测试用例或改进现有测试。请确保遵循以下步骤：

1. 创建一个新分支用于开发
2. 添加或修改测试
3. 确保所有测试都能通过
4. 提交拉取请求，详细说明更改内容

## 许可

与主项目使用相同的许可。 