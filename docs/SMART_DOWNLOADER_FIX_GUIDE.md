# æ™ºèƒ½æ¨èä¸‹è½½å™¨è®¾å¤‡æ£€æµ‹ä¿®å¤æŒ‡å—

## é—®é¢˜æè¿°

æ™ºèƒ½æ¨èä¸‹è½½å™¨çš„è®¾å¤‡æ£€æµ‹åŠŸèƒ½å­˜åœ¨ä»¥ä¸‹é—®é¢˜ï¼š

1. **ç¼“å­˜æœºåˆ¶å¯¼è‡´ç¡¬ä»¶é…ç½®å›ºåŒ–**ï¼šå½“ç¨‹åºä»æ— ç‹¬æ˜¾è®¾å¤‡è¿ç§»åˆ°æœ‰ç‹¬æ˜¾è®¾å¤‡æ—¶ï¼Œç¼“å­˜çš„ç¡¬ä»¶ä¿¡æ¯ä»ç„¶æ˜¯æ—§çš„
2. **GPUæ£€æµ‹ä¸å¤Ÿå‡†ç¡®**ï¼šæ˜¾å­˜ä¼°ç®—ä¸å‡†ç¡®ï¼Œå¯èƒ½å¯¼è‡´æ€§èƒ½ç­‰çº§è¯„ä¼°åä½
3. **æ¨èé…ç½®åä¿å®ˆ**ï¼šå³ä½¿æ£€æµ‹åˆ°é«˜æ€§èƒ½ç¡¬ä»¶ï¼Œæ¨èçš„é‡åŒ–ç­‰çº§å¯èƒ½ä»ç„¶åä¿å®ˆ

## ä¿®å¤å†…å®¹

### 1. ä¼˜åŒ–GPUæ£€æµ‹é€»è¾‘

**æ–‡ä»¶**: `src/core/hardware_detector.py`

**æ”¹è¿›å†…å®¹**:
- æ”¯æŒå¤šç§GPUæ£€æµ‹æ–¹æ³•ï¼ˆGPUtilã€PyTorch CUDAã€pynvmlï¼‰
- å‡†ç¡®è·å–æ˜¾å­˜ä¿¡æ¯ï¼Œé¿å…ä½¿ç”¨å›ºå®šä¼°ç®—å€¼
- æ·»åŠ è¯¦ç»†çš„æ£€æµ‹æ—¥å¿—å’Œé”™è¯¯å¤„ç†
- æ”¯æŒé›†æˆæ˜¾å¡æ£€æµ‹

**å…³é”®ç‰¹æ€§**:
```python
# å¤šç§æ£€æµ‹æ–¹æ³•çš„å›é€€æœºåˆ¶
detection_methods = [
    "gputil",        # æœ€å‡†ç¡®çš„æ˜¾å­˜ä¿¡æ¯
    "pytorch_cuda",  # PyTorch CUDAæ£€æµ‹
    "pynvml",        # NVIDIAç®¡ç†åº“
    "system_inference"  # ç³»ç»Ÿä¿¡æ¯æ¨æ–­
]
```

### 2. ä¿®å¤ç¼“å­˜æœºåˆ¶

**æ–‡ä»¶**: `src/core/intelligent_model_selector.py`

**æ”¹è¿›å†…å®¹**:
- æ·»åŠ ç¡¬ä»¶å˜åŒ–æ£€æµ‹æœºåˆ¶
- æ”¯æŒå¼ºåˆ¶åˆ·æ–°ç¡¬ä»¶é…ç½®
- è®°å½•ç¡¬ä»¶é…ç½®å˜åŒ–æ—¥å¿—

**å…³é”®æ–¹æ³•**:
```python
def force_refresh_hardware(self):
    """å¼ºåˆ¶åˆ·æ–°ç¡¬ä»¶é…ç½®ï¼ˆå…¬å…±æ¥å£ï¼‰"""
    
def _should_force_refresh_hardware(self) -> bool:
    """æ£€æŸ¥æ˜¯å¦éœ€è¦å¼ºåˆ¶åˆ·æ–°ç¡¬ä»¶é…ç½®"""
```

### 3. ä¼˜åŒ–æ€§èƒ½è¯„ä¼°

**æ”¹è¿›å†…å®¹**:
- æé«˜GPUè¯„åˆ†æƒé‡ï¼Œç¡®ä¿ç‹¬æ˜¾è®¾å¤‡èƒ½å¾—åˆ°é«˜åˆ†
- ç»†åŒ–é‡åŒ–ç­‰çº§æ¨èç­–ç•¥
- æ ¹æ®GPUç±»å‹å’Œæ˜¾å­˜å¤§å°æ¨èåˆé€‚çš„é…ç½®

**è¯„åˆ†ç­–ç•¥**:
```python
# NVIDIAç‹¬æ˜¾è¯„åˆ†
if gpu_memory_gb >= 24: return 35  # é«˜ç«¯æ˜¾å¡
elif gpu_memory_gb >= 16: return 30  # ä¸­é«˜ç«¯æ˜¾å¡
elif gpu_memory_gb >= 12: return 25  # ä¸­ç«¯æ˜¾å¡
elif gpu_memory_gb >= 8: return 20   # å…¥é—¨ç‹¬æ˜¾
```

### 4. æ™ºèƒ½æ¨èä¼˜åŒ–

**æ–‡ä»¶**: `src/core/enhanced_model_downloader.py`

**æ”¹è¿›å†…å®¹**:
- åœ¨æ™ºèƒ½ä¸‹è½½å‰å¼ºåˆ¶åˆ·æ–°ç¡¬ä»¶é…ç½®
- æ·»åŠ è¯¦ç»†çš„æ¨èç»“æœæ—¥å¿—
- æ”¹è¿›é”™è¯¯å¤„ç†å’Œå›é€€æœºåˆ¶

## ä½¿ç”¨æ–¹æ³•

### 1. è¿è¡Œä¿®å¤è„šæœ¬

```bash
python fix_smart_downloader_device_detection.py
```

è¿™ä¸ªè„šæœ¬ä¼šï¼š
- éªŒè¯å½“å‰ç¡¬ä»¶æ£€æµ‹é—®é¢˜
- æµ‹è¯•ä¿®å¤åçš„åŠŸèƒ½
- ç”Ÿæˆè¯¦ç»†çš„ä¿®å¤æŠ¥å‘Š

### 2. æ‰‹åŠ¨éªŒè¯

#### ç¡¬ä»¶è°ƒè¯•
```python
from src.utils.hardware_debug import run_hardware_debug

# è¿è¡Œå…¨é¢çš„ç¡¬ä»¶æ£€æµ‹è°ƒè¯•
debug_results = run_hardware_debug()
```

#### æµ‹è¯•æ™ºèƒ½æ¨è
```python
from src.core.intelligent_model_selector import IntelligentModelSelector

selector = IntelligentModelSelector()

# å¼ºåˆ¶åˆ·æ–°ç¡¬ä»¶é…ç½®
selector.force_refresh_hardware()

# æµ‹è¯•æ¨è
recommendation = selector.recommend_model_version("qwen2.5-7b")
print(f"æ¨èé‡åŒ–ç­‰çº§: {recommendation.variant.quantization.value}")
```

### 3. éªŒè¯ä¿®å¤æ•ˆæœ

è¿è¡Œä¿®å¤è„šæœ¬åï¼Œæ£€æŸ¥ä»¥ä¸‹æŒ‡æ ‡ï¼š

1. **GPUæ£€æµ‹å·¥ä½œ** âœ…
   - èƒ½æ­£ç¡®æ£€æµ‹åˆ°ç‹¬æ˜¾
   - æ˜¾å­˜ä¿¡æ¯å‡†ç¡®

2. **é«˜æ€§èƒ½æ£€æµ‹** âœ…
   - æœ‰ç‹¬æ˜¾è®¾å¤‡è¯„ä¼°ä¸ºHIGHæˆ–ULTRAç­‰çº§
   - æ€§èƒ½åˆ†æ•°åˆç†

3. **åˆé€‚é‡åŒ–æ¨è** âœ…
   - æœ‰ç‹¬æ˜¾è®¾å¤‡æ¨èQ5_Kæˆ–Q8_0
   - æ— ç‹¬æ˜¾è®¾å¤‡æ¨èQ4_K_Mæˆ–Q2_K

4. **ç¼“å­˜åˆ·æ–°å·¥ä½œ** âœ…
   - è®¾å¤‡è¿ç§»åèƒ½æ£€æµ‹åˆ°æ–°ç¡¬ä»¶
   - ç¡¬ä»¶å˜åŒ–æ—¶è‡ªåŠ¨åˆ·æ–°

## é¢„æœŸæ•ˆæœ

### ä¿®å¤å‰
- æ— ç‹¬æ˜¾è®¾å¤‡ â†’ æ¨èQ5_Kï¼ˆé”™è¯¯ï¼‰
- æœ‰ç‹¬æ˜¾è®¾å¤‡ â†’ æ¨èQ5_Kï¼ˆå¯èƒ½ä¸æ˜¯æœ€ä¼˜ï¼‰

### ä¿®å¤å
- æ— ç‹¬æ˜¾è®¾å¤‡ â†’ æ¨èQ2_Kæˆ–Q4_K_Mï¼ˆåˆé€‚ï¼‰
- æœ‰ç‹¬æ˜¾è®¾å¤‡ â†’ æ¨èQ5_Kæˆ–Q8_0ï¼ˆå……åˆ†åˆ©ç”¨ç¡¬ä»¶ï¼‰

## é…ç½®æ–‡ä»¶æ›´æ–°

### model_config.yaml
```yaml
quantization:
  available_levels:
    Q8_0:
      memory_usage: 8000  # MB
      quality_score: 95.0
      description: "æœ€é«˜ç²¾åº¦ï¼Œé€‚åˆé«˜ç«¯ç‹¬æ˜¾"
      use_case: "ultra_performance"
    Q5_K:
      memory_usage: 6300  # MB
      quality_score: 91.2
      description: "é«˜è´¨é‡é‡åŒ–ï¼Œé€‚åˆä¸­é«˜ç«¯ç‹¬æ˜¾"
      use_case: "performance"
```

### hardware_adaptive_config.yaml
```yaml
gpu:
  nvidia_priority: true
  min_vram_gb: 2
  fallback_to_cpu: true
  detection_methods:
    - "gputil"
    - "pytorch_cuda"
    - "pynvml"
```

## æ•…éšœæ’é™¤

### é—®é¢˜1: GPUæ£€æµ‹å¤±è´¥
**è§£å†³æ–¹æ¡ˆ**:
1. æ£€æŸ¥GPUé©±åŠ¨æ˜¯å¦æ­£ç¡®å®‰è£…
2. è¿è¡Œç¡¬ä»¶è°ƒè¯•è„šæœ¬æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯
3. ç¡®è®¤PyTorch CUDAæ”¯æŒ

### é—®é¢˜2: æ¨èç»“æœä»ç„¶ä¿å®ˆ
**è§£å†³æ–¹æ¡ˆ**:
1. å¼ºåˆ¶åˆ·æ–°ç¡¬ä»¶é…ç½®
2. æ£€æŸ¥æ€§èƒ½ç­‰çº§è¯„ä¼°ç»“æœ
3. éªŒè¯GPUæ˜¾å­˜æ£€æµ‹æ˜¯å¦å‡†ç¡®

### é—®é¢˜3: ç¼“å­˜æœªåˆ·æ–°
**è§£å†³æ–¹æ¡ˆ**:
1. æ‰‹åŠ¨è°ƒç”¨`force_refresh_hardware()`
2. é‡å¯åº”ç”¨ç¨‹åº
3. æ£€æŸ¥ç¡¬ä»¶å˜åŒ–æ£€æµ‹é€»è¾‘

## æ—¥å¿—åˆ†æ

å…³é”®æ—¥å¿—ä¿¡æ¯ï¼š
```
ğŸ” å¼€å§‹GPUæ£€æµ‹...
âœ… GPUtilæ£€æµ‹æˆåŠŸ: 1ä¸ªNVIDIA GPU, æ€»æ˜¾å­˜: 12.0GB
ğŸ’¾ ç¡¬ä»¶é…ç½®å·²ç¼“å­˜: GPU=12.0GB, RAM=16.0GB
ğŸ”„ æ£€æµ‹åˆ°ç¡¬ä»¶é…ç½®å˜åŒ–: GPUæ˜¾å­˜: 0.0GB -> 12.0GB
âœ… è·å–æ¨èæˆåŠŸ: é‡åŒ–: Q5_K, å¤§å°: 6.3GB
```

## æŠ€æœ¯ç»†èŠ‚

### GPUæ£€æµ‹ä¼˜å…ˆçº§
1. **GPUtil** - æœ€å‡†ç¡®çš„æ˜¾å­˜ä¿¡æ¯
2. **PyTorch CUDA** - å¹¿æ³›å…¼å®¹
3. **pynvml** - NVIDIAå®˜æ–¹åº“
4. **ç³»ç»Ÿæ¨æ–­** - é›†æˆæ˜¾å¡æ£€æµ‹

### æ€§èƒ½è¯„åˆ†ç®—æ³•
```python
total_score = memory_score + cpu_score + gpu_score

# GPUåˆ†æ•°æƒé‡æœ€é«˜ï¼ˆæœ€å¤š35åˆ†ï¼‰
# å†…å­˜åˆ†æ•°ï¼ˆæœ€å¤š30åˆ†ï¼‰
# CPUåˆ†æ•°ï¼ˆæœ€å¤š35åˆ†ï¼‰

if total_score >= 80: return ULTRA
elif total_score >= 60: return HIGH
elif total_score >= 40: return MEDIUM
else: return LOW
```

### é‡åŒ–æ¨èç­–ç•¥
```python
if performance_level == ULTRA and gpu_memory >= 16:
    return "Q8_0"  # æœ€é«˜ç²¾åº¦
elif performance_level == HIGH and gpu_memory >= 8:
    return "Q5_K"  # é«˜ç²¾åº¦
else:
    return "Q4_K_M"  # å¹³è¡¡é…ç½®
```

## ç»´æŠ¤å»ºè®®

1. **å®šæœŸéªŒè¯**ï¼šæ¯æ¬¡é‡å¤§æ›´æ–°åè¿è¡Œä¿®å¤è„šæœ¬éªŒè¯
2. **ç›‘æ§æ—¥å¿—**ï¼šå…³æ³¨ç¡¬ä»¶æ£€æµ‹ç›¸å…³çš„æ—¥å¿—ä¿¡æ¯
3. **ç”¨æˆ·åé¦ˆ**ï¼šæ”¶é›†ç”¨æˆ·åœ¨ä¸åŒç¡¬ä»¶é…ç½®ä¸‹çš„ä½¿ç”¨ä½“éªŒ
4. **æ€§èƒ½æµ‹è¯•**ï¼šå®šæœŸæµ‹è¯•ä¸åŒé‡åŒ–ç­‰çº§çš„å®é™…æ€§èƒ½è¡¨ç°

## ç›¸å…³æ–‡ä»¶

- `src/core/hardware_detector.py` - ç¡¬ä»¶æ£€æµ‹å™¨
- `src/core/intelligent_model_selector.py` - æ™ºèƒ½æ¨¡å‹é€‰æ‹©å™¨
- `src/core/enhanced_model_downloader.py` - å¢å¼ºæ¨¡å‹ä¸‹è½½å™¨
- `src/utils/hardware_debug.py` - ç¡¬ä»¶è°ƒè¯•å·¥å…·
- `fix_smart_downloader_device_detection.py` - ä¿®å¤è„šæœ¬
- `configs/model_config.yaml` - æ¨¡å‹é…ç½®
- `configs/hardware_adaptive_config.yaml` - ç¡¬ä»¶è‡ªé€‚åº”é…ç½®
